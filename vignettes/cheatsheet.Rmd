---
title: "Durga Cheat Sheet"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Durga Cheat Sheet}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Durga)
library(datasets)
data(iris)
```

`Durga` is an R package that aims to simplify the estimation and visualisation of one type of effect size: differences in means. It provides a function, `DurgaDiff`, to estimate raw or standardised mean differences. Most importantly, it provides a function, `DurgaPlot`, that will create a plot for visualising both the original data and the effect size, providing a diverse range of display options. The function `DurgaBrackets` can add _confidence brackets_ to an existing Durga plot. This vignette shows some example Durga plots. Each plot is preceded by the code used to generate it, which can be used to learn how to create the plot. 

Before plotting your data, you must estimate the differences in group means by calling `DurgaDiff`. Your data should be in a data frame (or similar), with one observation per row - this is known as _long format_ data. The data frame must contain a column for the measurement or value being analysed, and another for the group or treatment. Additional, paired or repeated measures data requires an ID column to match measurements for the same specimen/individual. For example, within the `insulin` data set, the value being measured - blood sugar level - is recorded in the column `sugar`; treatments are `before` and `after` in the `treatment` column; and the identity of the individual (rabbit) being tested is given in the `id` column. the blood sugar level of each rabbit was tested before and after treatment with insulin, so, for each rabbit, there is a row with the `before` sugar level, and another with the `after` sugar level.

```{r} 
head(insulin[insulin$id < 4, ])
d <- DurgaDiff(insulin, "sugar", "treatment", "id")
print(d)
```

When plotted, groups are displayed in their natural order, i.e. alphabetical order for character data, and numeric order for factors. You can, however, specify the display order with the `groups` parameter to either `DurgaDiff` or `DurgaPlot`. Not all groups in the data need be included in the analysis or plot. To assign display labels to the groups, use a named vector to list the groups. The names will be used to label the groups on the plot. 

In the damselfly data set, the groups are `juvenile` and `adult`. The example below demonstrates firstly the default names and group order, then how to change the displayed group names as well as the display order of the groups.



```{r fig.height=4, fig.width=8}
par(mfrow = c(1, 2))
# There are missing values in the damselfly data set, so specify na.rm = TRUE
d <- DurgaDiff(damselfly, "weight", "group", na.rm = TRUE)
DurgaPlot(d, main = "Default display")

d <- DurgaDiff(damselfly, "weight", "group", na.rm = TRUE,
                   groups = c("Immature" = "juvenile", "Mature" = "adult"))
DurgaPlot(d, main = "Groups labelled and ordered", left.ylab = "Weight")
```

A `DurgaPlot` raw data visualisation is a combination of one or more visual components: data `points`; `violin` plots; `bar` charts; `box` plots; a mean or median indicator (`central.tendency`); and error bars (`error.bars`). Each component is controlled by a set of parameters. The names of the parameters indicate the component they apply to, so to adjust the violin plot component, read the documentation about all parameters starting with `violin`. Parameters have sensible default values, so for example, if you turn on bar charts, then violin plots and the central tendency indicator will be turned off. Obviously, you are able to override the defaults if you wish.

The colours of all components can controlled using the appropriate parameters. A single colour may be specified, or different colours can be set for each group. Points can be coloured individually or by group. The default `pch` for points is 19.

```{r fig.height=5, fig.width=8.5}
par(mfrow = c(1, 2), mar = c(11, 4, 3, 6) + 0.1)
# Only show 2 groups even though there are 3 in the data
d <- DurgaDiff(iris, data.col = "Sepal.Length", group.col = "Species",
                   groups = c("versicolor", "setosa"))
# Custom colours - the points are partially transparent
DurgaPlot(d, 
        points = c(DurgaTransparent("coral", .6), DurgaTransparent("darkturquoise", .8)),
        violin = c("red", "blue"), violin.fill = c("#f8a8c840", "#a8c8f840"), 
        main = "Two colours")

par(mar = c(5, 4, 3, 1) + 0.1)
d <- DurgaDiff(iris, data.col = "Sepal.Length", group.col = "Species")
bgCols <- c(DurgaTransparent("red", 0.5), 
            DurgaTransparent("blue", 0.5), 
            DurgaTransparent("green", 0.5))
DurgaPlot(d, box = "grey50", box.fill = "grey90",
        points = "black", 
        points.params = list(pch = 22, cex = 0.8, bg = bgCols[iris$Species]),
        main = "Coloured point fill")
```

Error bars on each group may show the 95% confidence intervals of the mean, standard deviation or standard error, and may be plotted regardless of what other components are shown.
 
```{r fig.height=6, fig.width=9}
par(mfrow = c(1, 2))
d <- DurgaDiff(iris, data.col = "Sepal.Length", group.col = "Species")
DurgaPlot(d, bar = TRUE, error.bars.type = "SD", points = FALSE, violin = FALSE, 
        main = "Bar chart with std. deviation")

DurgaPlot(d, error.bars.type = "CI", central.tendency = rainbow(3), 
        points = FALSE, violin = FALSE, main = "Mean and 95% CI")
```

When there are too many group comparisons to be displayed underneath, you can choose to display confidence brackets above the plot. Confidence brackets communicate less information than the standard effect size visualisation, but may be a reasonable compromise for many group comparisons. You must manually ensure there is sufficient space for the brackets in the plot (see `DurgaBrackets` for details). 

```{r fig.height=4, fig.width=7}
d <- DurgaDiff(petunia, 1, 2)
# Use the top margin for brackets
op <- par(mar = c(2, 4, 4, 1) + 0.1)
on.exit(par(op))
# Don't draw frame because brackets will appear in the upper margin
p <- DurgaPlot(d, ef.size = FALSE, frame.plot = FALSE)
# For each difference, record whether it overlaps 0, is negative or positive
sign <- sapply(d$group.differences, function(diff) ifelse(diff$bca[5] < 0, -1, 
                                                           ifelse(diff$bca[4] > 0, 1, 0)))
lwd <- ifelse(sign == 0, 1, 2)
font <- ifelse(sign == 0, 1, 2)
lb.col <- ifelse(sign == 0, "grey60", "grey20")
br.col <- ifelse(sign < 0, "red", ifelse(sign > 0, "blue", "grey60"))
DurgaBrackets(p, labels = "diff CI", lb.cex = 0.8, lb.col = lb.col, lb.font = font, 
              br.col = br.col, br.lwd = lwd)
```

By default, effect sizes are "unstandardised", which means they are in the same units as the data. Alternatively, `DurgaDiff` can estimate standardised effect sizes, either Cohen's d or Hedges' g, which allow comparisons of effect sizes across data in different units.

You can override the y-axis labels to aid interpretation of effect sizes. `DurgaPlot` does not provide text labels by default because effect size interpretation depends on context.

```{r fig.height=6, fig.width=8}
par(mar = c(5, 9, 3, 1) + 0.1)
effectSizes <- c("No effect" = 0, "Large positive effect" = 0.8, "Huge positive effect" = 2)
groups <- c("Self" = "self_fertilised", "Westerham" = "westerham_cross", "Inter" = "inter_cross")
d <- DurgaDiff(petunia, 1, 2, effect.type = "cohens", groups = groups)
DurgaPlot(d, violin = F, main = "Cohen's d, labelled effect size", 
          points.method = "jitter", 
          ef.size.ticks = effectSizes, ef.size.label = "", ef.size.las = 1)
```

Groups can be offset horizontally from their default positions. Individual components (i.e. violins, points etc.) can be offset independently.

```{r fig.height=5, fig.width=7}
par(mar = c(5, 4, 3, 1) + 0.1)
set.seed(1)
# Construct some data
data <- data.frame(Measurement = unlist(lapply(c(10, 12, 8, 8.5, 9, 9.1), function(m) rnorm(20, m))),
                   Group = rep(paste0("g", 1:6), each = 20),
                   Id = rep(1:6, 20))
groups = c("Control 1" = "g1", "Treatment 1" = "g2", 
           "Control 2" = "g3", "Treatment 2" = "g4", 
           "Control 3" = "g5", "Treatment 3" = "g6")
d <- DurgaDiff(data, 1, 2, 3, groups = groups, 
                   contrasts = "g2 - g1, g4 - g3, g6 - g5")
# Reduce text size
par(cex = 0.7)
DurgaPlot(d, box = TRUE, group.dx = c(0.15, -0.15), paired = FALSE, points = FALSE, 
        box.pars = list(boxwex = 0.4), ef.size.violin = FALSE, main = "Group offsets",
        xlim = c(1, 6))
```

Any unknown parameters to `DurgaPlot` are passed on to the plot function, which allows some control over additional aspects of the plot. The labels underneath effect sizes can be controlled by passing a named vector for the `DurgaPlot` `contrasts` parameter.

```{r fig.height=5, fig.width=7}
# Add in some fake sex data to the insulin data set
data <- cbind(insulin, Sex = sample(c("Male", "Female"), nrow(insulin), replace = TRUE))
# Thin it the data so individual symbols are visible
data <- data[data$id %in% 1:15, ]

d <- DurgaDiff(data, "sugar", "treatment", "id", 
                   groups = c("Before insulin" = "before", "After insulin" = "after"), na.rm = TRUE)
par(mar = c(2, 4, 4, 1))
DurgaPlot(d, 
          frame.plot = FALSE, # Don't draw containing box
          contrasts = c("Change in sugar" = "after - before"),
          left.ylab = "Blood sugar level",
          violin.shape = c("left", "right"), violin.dx = c(-0.055, 0.055), violin.width = 0.3, 
          points = "black",
          points.params = list(bg = ifelse(data$Sex == "Female", "red", "blue"), 
                               pch = ifelse(data$Sex == "Female", 21, 24)), 
          ef.size.pch = 19,
          ef.size.violin = "blue",
          ef.size.violin.shape = "full",
          central.tendency = FALSE,
          main = "Customised plot")
legend("topright", c("Female", "Male"), pch = c(21, 24), pt.bg = c("red", "blue"))
```

